# Colab UI/UX設計書 (改訂版)
本書はYAIBAで生成されたログから統計・可視化・動画情報を取得するシステムの全体的なUI/UXに関する設計書です。

## 1. 目的と範囲
### 目的
VRChatのギミック「YAIBA」で取得した位置情報データを、プログラミング知識がないユーザーでもGoogle Colaboratory上で簡単にアップロードし、各種統計情報やグラフとして可視化できるようにする。これにより、ユーザーは自身のVRChat内での活動データを容易に分析・共有することを実現する。

### 範囲
- Google ColabのUI（ボタン、入力フィールド）を通じた基本的な操作
- YAIBAから出力されたログファイル、または標準化された中間ファイル（CSV/Parquet）のアップロード
- ログファイルから各種成果物（ヒートマップ、ヒストグラム、動画など）の生成
- 生成された成果物の一括ダウンロード

## 2. UIの全体構成
ユーザーは以下のセクションを上から順に実行することで、データの可視化とダウンロードを行える。

### セクション1: セットアップ
- **内容**: 必要なライブラリ群をインストールするためのセル。ユーザーは最初のセルを実行するだけで環境構築が完了する。
- **UI**: `pip install ...` が記述されたコードセルと実行ボタン。

### セクション2: プライバシーポリシーと同意事項
- **内容**: 本ツールの利用に関する注意事項を表示する。
- **UI**: 以下のテキストを表示する。
  > **【重要】プライバシーとデータの取り扱いについて**
  > - 本ツールは、VRChatワールドギミック「YAIBA-VRC」によって位置情報や回転情報の取得に**同意したユーザーのログ**のみを扱うことを想定しています。
  > - ファイルをアップロードすることにより、データがGoogle Colaboratoryのサーバーに送信され、処理されることに同意したものとみなします。これは**第三者提供**に準ずる行為となりますので、取り扱うデータの内容には十分ご注意ください。

### セクション3: ファイル入力
- **内容**: 分析対象のファイルをアップロードする。
- **UI**: ファイルアップロードボタンを表示。

### セクション4: パラメータ設定
- **内容**: 可視化の条件を設定する。
- **UI**:
  - **期間指定**:
    - `[ ] 全期間を対象にする` チェックボックス。チェック時、以下の日付・時刻入力は無効化される。
    - **開始と終了**: `DatePicker` を使い日付と時間を選択できる仕様にする

### セクション5: 実行
- **内容**: 設定された内容に基づき、全ての処理（データ前処理、可視化、動画生成）を実行する。
- **UI**: 「実行」ボタン。ヒートマップから動画まで生成する。

### セクション6: 結果の確認とダウンロード
- **内容**: 生成された各種成果物と、処理済みの中間データを表示し、ダウンロードリンクを提供する。
- **UI**:
  - 生成されたヒートマップ画像、ヒストグラム画像、動画（mp4）のインライン表示。
  - `[中間データ(CSV/Parquet)をダウンロード]` ボタン
  - 全ての成果物をまとめたZIPファイルのダウンロードリンク。

## 3. 入力仕様
- **データ形式**: 以下のいずれかの形式に対応する。
  1. **YAIBA生ログ**: YAIBAギミックから出力されたままのテキストファイル (`.log`, `.txt`)。
  2. **中間データ**: A工程（データ取り込み・前処理）によって生成された、特定のカラムを持つCSVまたはParquetファイル。
     - **必須カラム**: `second`, `userid`, `location_x`, `location_y`, `location_z`, `event_day` 等。

- **タイムゾーン**: YAIBAのログに記録されている**ローカルタイム**を基準とし、タイムゾーン変換は行わない。

## 4. 出力仕様
### 生成データ
「実行」ボタンを押下すると、以下の成果物が全て生成される。
- **ヒートマップ画像** (PNG形式)
- **滞在時間ヒストグラム画像** (PNG形式)
- **軌跡動画** (mp4形式)
- （その他、各工程で定義された統計情報テーブルなど）

### フォルダ構造
Colab環境内に一時的なフォルダを作成し、以下のような構造で成果物を保存する。ダウンロード時には `output` フォルダがZIP圧縮される。
```
/content/
|-- YAIBA_data/
|   |-- input/
|   |   `-- (アップロードされたファイル)
|   |-- intermediate/
|   |   `-- (処理中に生成される中間ファイル)
|   `-- output/
|       |-- heatmap.png
|       |-- histogram.png
|       |-- trajectory.mp4
|       `-- (その他テーブル等)
|-- src/
|   |-- (各工程のPythonモジュール)
`-- YAIBA_Visualizer_output.zip (ダウンロード用ファイル)
```

## 5. UXの動作規則
- **全期間指定**: 「全期間を対象にする」がチェックされている場合、日付・時刻入力フィールドは無効（グレーアウト）になる。
- **ダウンサンプリング提案**: アップロードされたデータの行数が一定の閾値（例: 100万行）を超える場合、「データ量が非常に大きいため、処理に時間がかかる可能性があります。データを間引いて処理しますか？」といった内容の確認ダイアログを表示する。

## 6. 例外・エラー処理方針
処理中にエラーが発生した場合、UI上にはエラーの原因と対処法を簡潔に表示し、詳細はログファイルを確認するように促す。内部的にはエラーコード体系に基づいてエラーが記録される。

| カテゴリ | エラー概要 | UI表示メッセージ例 |
|:---|:---|:---|
| **入力エラー** | ファイルが見つからない | `[入力エラー] 指定されたファイルが見つかりません。ファイルをアップロードし直してください。` |
| | ファイル形式が不正 | `[入力エラー] 対応していないファイル形式です。YAIBAログ(.log, .txt)または標準ファイル(.csv, .parquet)をアップロードしてください。` |
| | データフォーマットが不正 | `[入力エラー] ファイル内のデータ形式が正しくありません。必須データ(時刻, ユーザーID等)が欠けていないか、ファイルが破損していないか確認してください。` |
| | データの内容が異常 | `[入力エラー] データに異常な値が含まれています。入力データを確認してください。` |
| **データ処理・可視化エラー** | 処理対象データなし | `[処理エラー] 指定された条件に一致するデータがありませんでした。期間などのパラメータを変更して再度お試しください。` |
| | グラフ生成の失敗 | `[可視化エラー] グラフの生成中に問題が発生しました。データが少なすぎるか、特殊な値が含まれている可能性があります。詳細はログファイルを確認してください。` |
| | 処理タイムアウト | `[タイムアウト] 処理が時間内に完了しませんでした。データ量を減らすか、期間を短くして再度お試しください。` |
| **出力エラー** | ファイルの書き込み失敗 | `[出力エラー] 結果の保存に失敗しました。ディスク容量や権限に問題がある可能性があります。詳細はログファイルを確認してください。` |
| | 成果物が生成されない | `[出力エラー] 最終的な成果物ファイルが生成されませんでした。処理中に問題が発生した可能性があります。詳細はログファイルを確認してください。` |
| **全般** | その他の予期せぬエラー | `[不明なエラー] 予期せぬエラーが発生しました。お手数ですが、開発者にご連絡ください。詳細はログファイルを確認できます。` |

## 7. 性能・品質要件
- **処理時間**: **3時間×100人×1Hzのデータ（約108万行）に対し、全処理が3分以内に完了すること**を目標とする。
- **再現性**: 同じ入力データとパラメータであれば、常に同じ可視化結果が生成されること。
- **可用性**: Google Colaboratoryが利用可能な環境であれば、いつでも実行可能であること。

## 8. 検証方法
### 単体テスト
`pytest`による関数単位でのテストを想定。
- **正常系**: 仕様通りの入力に対し、意図した成果物が生成されることを確認。
- **異常系**: 想定外の入力に対し、定義されたエラーメッセージが返されることを確認。

### 結合テスト
実際にYAIBAから出力したログファイル（複数パターン）を使い、アップロードからダウンロードまでの一連のフローが問題なく動作することを確認する。
