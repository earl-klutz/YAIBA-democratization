# 15. エラーコード体系（-2000 ～ -2999）

上位コンポーネントへ返却するためのエラーコードを以下に定義する。範囲ごとに責務を明確化し、運用・監視で原因特定が容易となるように割当。

## 15.1 概要

- 使用範囲: -2000 ～ -2999
- 下位2桁: 詳細な原因コード
- 上位カテゴリ: 100単位で分割
  - **-21XX**: インプットエラー
  - **-22XX**: 接続数推移（CONCURRENT_USERS）
  - **-23XX**: 位置軌跡
  - **-24XX**: 基本統計
  - **-27XX**: 出力・書込・容量エラー（STORAGE_EXPORT）

---

## 15.2 インプットエラー (-21XX)

| コード  | 内容           | 発生条件例                         |
| ------- | ------------- | -------------------------------- |
| -2100   | 不明エラー        | 未分類の例外捕捉                      |
| -2101   | 入力ファイル欠落     | 指定CSVファイルが存在しない               |
| -2102   | フォーマット不正     | 必須列(timestamp, user_id)欠落      |
| -2103   | タイムスタンプ変換失敗 | 解析不能なフォーマット                   |
| -2104   | 型不一致         | 数値列に文字列など異常データ                |
| -2105   | 許容範囲外値       | 速度 > Vmax, 座標範囲外等             |

---

## 15.3 接続数推移 (-22XX, CONCURRENT_USERS)

| コード  | 内容                   | 発生条件例                                |
| ------- | ---------------------- | ----------------------------------- |
| -2200   | 不明エラー                | 未分類の例外捕捉                             |
| -2201   | セッション境界未確定           | join/leave欠落かつtimeout処理不可             |
| -2202   | CU計算失敗               | 集計バケット生成時のエラー                       |
| -2203   | 平滑化演算失敗              | SMA/EMA計算不能（NaN連鎖など）                 |
| -2204   | 表示データ不足              | CU系列が空                                 |
| -2205   | ユーザー数オーバの可能性（WARN） | ログデータに500名超のユーザーが存在する際の警告 |

---

## 15.4 位置軌跡 (-23XX)

| コード  | 内容        | 発生条件例             |
| ------- | ---------- | ------------------ |
| -2300   | 不明エラー     | 未分類の例外捕捉          |
| -2301   | 軌跡データ欠損  | x,y,zが全てNULL     |
| -2302   | 軌跡点数過多   | プロット点が閾値超過し描画不能 |
| -2303   | 軌跡補間失敗   | 欠損処理/分断処理でエラー   |
| -2304   | 背景マップ未読込 | 敷き込み用画像パス不正     |

---

## 15.5 基本統計 (-24XX)

| コード  | 内容          | 発生条件例                  |
| ------- | ------------ | ----------------------- |
| -2400   | 不明エラー       | 未分類の例外捕捉               |
| -2401   | 指標計算失敗      | 平均/中央値等の計算が例外で終了       |
| -2402   | パーセンタイル計算失敗 | 欠損やNaNでソート不可           |
| -2403   | サンプル数不足     | 指標算出に必要な最小点数を満たさない    |

---

## 15.6 出力・書込・容量エラー (-27XX, STORAGE_EXPORT)

| コード  | 内容       | 発生条件例                       |
| ------- | -------- | --------------------------- |
| -2701   | 書込先不正    | 出力ディレクトリが存在しない/無効            |
| -2702   | 権限不足     | トークン/認証/ファイル書込権限なし            |
| -2703   | 容量不足     | ディスク/クラウドストレージ容量超過             |
| -2704   | I/O例外    | 書込中のI/Oエラー                    |
| -2705   | 成果物未生成  | 必須成果物（CSV/画像等）が生成されなかった場合   |

---

## 15.7 運用方針

- 各エラーはログ出力時に**コード＋メッセージ**を必須併記。
- 上位システムはコード単位でリトライ可否や通知レベルを判断する。
- **-21XX（インプット系）**は致命的エラー扱い、後続処理スキップ。
- **-22XX～-24XX**は可能なら部分処理継続（例: 統計失敗でもCUグラフは生成）。
- **-27XX**は出力不備のため成果物が欠落する可能性あり、通知レベルを高めに設定すること。

