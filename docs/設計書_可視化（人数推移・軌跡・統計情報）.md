## 可視化（人数推移・軌跡・統計情報）
本書はYAIBAで生成されたログから統計・可視化情報を取得する{名称未定}システムの可視化（人数推移・軌跡・統計情報）に関する設計書である。

## 1. 目的と範囲
### 目的
- A工程が出力する中間形式テーブルを入力として、同時接続数の推移、位置軌跡2D、基本統計（max/mean/median/P95）を生成し、PNGおよびTXTで出力して配布可能にする。

### やること
- df_cc（同時接続数）、df_pos（位置）、area（境界）を受け取り、折れ線グラフ・軌跡図・統計TXTを作成する。
- UI/UX工程の出力フォルダ構成・命名規則に整合するファイル名で保存する。

### やらないこと
- 動画生成（C-2にて実施）。
- 高度な可視化（3D、対数スケール、属性別色分け等）はWant要件とし本仕様では扱わない。

## 2. 成果物（ファイル名・ファイル構成）
### 2-1) ファイル構成
```
/content/
├─ YAIBA_data/
│  ├─ input/
│  │   └─ <uploaded_log>.txt
│  └─ output/
│      ├─ results/
│      │   ├─ cc_line-{event_day}-{filename}-{datetime}{ver}.png
│      │   ├─ traj2D-{event_day}-{filename}-{datetime}{ver}.png
│      │   └─ stats-{event_day}-{filename}-{datetime}{ver}.txt
│      │
│      └─ meta/
│          ├─ configs/
│          │   └─ run_{ver}_params.yaml
│          └─ logs/
│              └─ run_{datetime}.log
│
├─ src/
│  └─ engine/
│      └─ core/
│          ├─ concurrency.py        # 同時接続数PNG生成
│          ├─ trajectory.py         # 軌跡PNG生成
│          ├─ stats_basic.py        # 基本統計算出・保存
│          ├─ validation.py         # 入力検証
│          ├─ naming.py             # 命名・パス生成
│          └─ logging_util.py       # ログ
```

### 2-2) コード実体（クラス/関数・I/O）
- concurrency.py
  - クラス: `ConcurrencyPlotter`
    - `__init__(self, render: dict, io: dict)`
    - `validate_df_cc(self, df_cc) -> None`
    - `resample_cc(self, df_cc, sec: int) -> pd.DataFrame`
    - `plot(self, df_cc) -> matplotlib.figure.Figure`
    - `save_png(self, fig, path: str) -> str`

- trajectory.py
  - クラス: `TrajectoryPlotter`
    - `__init__(self, area: dict, style: dict, io: dict)`
    - `validate_df_pos(self, df_pos) -> None`
    - `clip_by_area(self, df_pos, area: dict) -> pd.DataFrame`
    - `segment_by_gap(self, df_pos, gap_factor: float) -> list[pd.DataFrame]`
    - `plot(self, df_pos) -> matplotlib.figure.Figure`
    - `save_png(self, fig, path: str) -> str`

- stats_basic.py
  - 関数群
    - `compute_cc_stats(df_cc) -> dict`  # {"max":int,"mean":float,"median":float,"p95":float}
    - `save_stats_txt(stats: dict, path: str) -> str`

- naming.py / logging_util.py / validation.py はヒートマップ設計書の流儀に揃える。

## 5. 処理フロー（概要）
- 共通前処理
  - 入力検証（必須列、型、昇順、NaN率）
  - UTC→JST表示用の整備（表示はJST、計算はUTC）
  - ログ初期化・実行ID採番・パラメータ保存

- 人数推移グラフ（df_cc）
  - 欠測区間判定と分断（欠測が5×粒度以上）
  - 粒度`resample_sec`で再サンプリング（平均/合計は要件により選択、既定=平均）
  - 折れ線描画（タイトル、軸、凡例なし）
  - PNG保存

- 軌跡2D（df_pos, area）
  - 境界外クリップ（areaの両端閉）
  - ユーザーごとにソート、`break_gap_factor`に基づき線分断
  - 始点/終点マーカー、線幅1.5px、背景白
  - Areaにfit（比率維持・中央寄せ）
  - PNG保存

- 基本統計（df_cc）
  - `max`, `mean`, `median`, `p95` を算出（NaN除外、補間禁止）
  - TXT保存（再現性のため小数桁・丸めルール固定）

- ログサマリ出力（ユニーク件数、保存先、警告/エラー集計）
