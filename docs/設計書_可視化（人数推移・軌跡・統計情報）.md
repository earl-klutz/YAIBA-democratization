# イベントログ可視化・統計設計書（最終版・B工程）

---

## 1. 目的と範囲
### 目的
- A工程が出力する DataFrame を入力として：
  - 同時接続数グラフ（PNG）
  - ユーザー位置軌跡2D（PNG）
  - 統計指標（max/mean/median/P95, txt）
  を生成する。

### 範囲
- 入力検証
- 統計計算
- グラフ描画（同時接続数/位置軌跡2D）
- PNG/txt 出力
- ログ出力

### 前提（A工程）
- A工程が attendance, position, area を処理し、  
  df_cc (同時接続数)、df_pos (位置データ)、area (マップ境界) を提供する。  
- 本工程は A工程の計算結果を可視化・集計するのみ。

---

## 2. 成果物（クラス・メソッド定義）

### 2.1 設定クラス
```python
from dataclasses import dataclass
from typing import List, Optional, Literal

@dataclass(frozen=True)
class RenderConfig:
    event_day: str                # YYYY-MM-DD
    filename: str                 # 出力名
    dpi: int = 144
    width_px: int = 1280
    height_px: int = 720

@dataclass(frozen=True)
class TrajectoryConfig:
    color_scheme: Literal["by_user","by_speed","by_time"] = "by_user"
    break_gap_factor: float = 3.0
    start_marker_size_px: int = 6   # 始点circle直径(px)
    end_marker_size_px: int = 10    # 終点triangle一辺(px)
    filter_user_ids: Optional[List[str]] = None
    bounds: Optional[dict] = None   # {"min_x":..,"max_x":..,"min_z":..,"max_z":..}
    fit_mode: Literal["fit","fill","stretch"] = "fit"
    margin_px: int = 0
    clip_oob: bool = True
```

### 2.2 検証関数
```python
def validate_df_cc(df_cc) -> None:
    # 必須列[t, cc]・昇順・非負・NaN検証。不正時は例外発生。
    pass

def validate_df_pos(df_pos) -> None:
    # 必須列[t, user_id, x, z]・昇順・NaN率を検証。不正時は例外発生。
    pass
```

### 2.3 統計関数
```python
def compute_cc_stats(df_cc) -> dict:
    # 入力: df_cc[t, cc]
    # 出力: {"max":int, "mean":float, "median":float, "p95":float}
    pass
```

### 2.4 描画関数
```python
def render_concurrency_png(df_cc, rcfg: RenderConfig) -> str:
    # 同時接続数折れ線を描画しPNG保存
    # 出力: 'out/cc_line_{event_day}_{filename}.png'
    pass

def render_trajectory2d_png(df_pos, rcfg: RenderConfig, tcfg: TrajectoryConfig) -> str:
    # 軌跡を2Dで描画しPNG保存（Area境界にfit）
    # 出力: 'out/traj_{event_day}_{filename}.png'
    pass
```

### 2.5 出力関数
```python
def save_stats_txt(stats: dict, rcfg: RenderConfig) -> str:
    # 統計結果をtxtで保存
    # 形式:
    #   max: 124
    #   mean: 78.3
    #   median: 80
    #   p95: 115
    # 出力: 'out/stats_{event_day}_{filename}.txt'
    pass
```

### 2.6 エントリポイント
```python
def run(df_cc, df_pos, area: dict,
        rcfg: RenderConfig, tcfg: TrajectoryConfig) -> dict:
    # 1) validate_df_cc / validate_df_pos
    # 2) stats = compute_cc_stats(df_cc)
    # 3) p_cc = render_concurrency_png(df_cc, rcfg)
    # 4) p_tr = render_trajectory2d_png(df_pos, rcfg, tcfg)
    # 5) s_txt = save_stats_txt(stats, rcfg)
    # 戻り値: {"cc_png": p_cc, "traj_png": p_tr, "stats_txt": s_txt}
    pass
```

---

## 3. 出力仕様
- PNG画像: 1280×720, DPI=144
- 統計: txt  
  ```
  max: 124
  mean: 78.3
  median: 80
  p95: 115
  ```
- ログ: out/run.log

---

## 4. 軌跡2D描画仕様
- 投影: x–z 平面
- スケーリング: Area境界をfit（比率維持, 中央寄せ）
- 始点: circle 6px
- 終点: triangle 10px
- 線幅: 1.5px
- break_gap_factor超過で線分断
- clip_oob=Trueで枠外は描画しない
- 背景: 白, 軸付き, 単位[m]

---

## 5. エラー処理
- 入力DataFrame欠落/型不正 → -2101/-2301
- cc負値 → -2204
- Area不正（範囲0以下）→ -2301
- 出力先権限なし → -2702

---

## 6. 性能・品質要件
- 100万行を10分以内で処理
- PNG出力は固定サイズ/解像度
- txt出力の統計は再現性保証
- 欠損データがあっても処理継続可能

---

## 7. 検証方法
- df_ccから統計を手計算し、txtと一致確認
- PNG出力の目視（始点circle/終点triangleのサイズ確認）
- Area境界に基づき正しくスケーリングされるか
- 不正入力でエラー発報するか
- 性能試験（100万行, 10分以内）

---

## 8. 参考章: 統計・数式補足

### 8.1 同時接続数系列 C(t)
- Peak (max):  
  max_t C(t)
- Mean (平均):  
  (Σ C(t)) / N
- Median (中央値):  
  昇順に並べたときの50%点
- 95%タイル (P95):  
  系列C(t)の95%点（線形補間または最近傍補間）

※ 欠損値は除外。前方埋めは禁止（在席誤判定防止）。

### 8.2 折れ線グラフの時間分解能
- 再サンプリング間隔: resample_sec 秒（既定1秒、5秒）
- 欠測区間が 5 × resample_sec を超えた場合は線を分断
- 短い欠測は空白のまま、補間は行わない

### 8.3 軌跡系の派生量
- 区間距離 (2D):  
  dist_i = sqrt((x_i - x_{i-1})^2 + (z_i - z_{i-1})^2)
- 速度:  
  v_i = dist_i / Δt_i,  Δt_i = t_i - t_{i-1} (秒)
- 速度統計:  
  max(v), mean(v), P95(v)

### 8.4 外れ値処理
- 速度・距離: 分位クリップ (p1〜p99) を既定とする
- 同時接続数: 整数値なので外れ値処理不要
