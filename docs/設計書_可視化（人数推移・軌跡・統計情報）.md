## 可視化（人数推移・軌跡・統計情報）
本書はYAIBAで生成されたログから統計・可視化情報を取得する{名称未定}システムの可視化（人数推移・軌跡・統計情報）に関する設計書である。

## 1. 目的と範囲
### 目的
- A工程が出力する中間形式テーブルを入力として、同時接続数の推移、位置軌跡2D、基本統計（max/mean/median/P95）を生成し、PNGおよびTXTで出力して配布可能にする。

### やること
- df_cc（同時接続数）、df_pos（位置）、area（境界）を受け取り、折れ線グラフ・軌跡図・統計TXTを作成する。
- UI/UX工程の出力フォルダ構成・命名規則に整合するファイル名で保存する。

### やらないこと
- 動画生成（C-2にて実施）。
- 高度な可視化（3D、対数スケール、属性別色分け等）はWant要件とし本仕様では扱わない。

## 2. 成果物（ファイル名・ファイル構成）
### 2-1) ファイル構成
```
/content/
├─ YAIBA_data/
│  ├─ input/
│  │   └─ <uploaded_log>.txt
│  └─ output/
│      ├─ results/
│      │   ├─ cc_line-{event_day}-{filename}-{datetime}{ver}.png
│      │   ├─ traj2D-{event_day}-{filename}-{datetime}{ver}.png
│      │   └─ stats-{event_day}-{filename}-{datetime}{ver}.txt
│      │
│      └─ meta/
│          ├─ configs/
│          │   └─ run_{ver}_params.yaml
│          └─ logs/
│              └─ run_{datetime}.log
│
├─ src/
│  └─ engine/
│      └─ core/
│          ├─ concurrency.py        # 同時接続数PNG生成
│          ├─ trajectory.py         # 軌跡PNG生成
│          ├─ stats_basic.py        # 基本統計算出・保存
│          ├─ validation.py         # 入力検証
│          ├─ naming.py             # 命名・パス生成
│          └─ logging_util.py       # ログ
```

### 2-2) コード実体（クラス/関数・I/O）
- concurrency.py
  - クラス: `ConcurrencyPlotter`
    - `__init__(self, render: dict, io: dict)`
    - `validate_df_cc(self, df_cc) -> None`
    - `resample_cc(self, df_cc, sec: int) -> pd.DataFrame`
    - `plot(self, df_cc) -> matplotlib.figure.Figure`
    - `save_png(self, fig, path: str) -> str`

- trajectory.py
  - クラス: `TrajectoryPlotter`
    - `__init__(self, area: dict, style: dict, io: dict)`
    - `validate_df_pos(self, df_pos) -> None`
    - `clip_by_area(self, df_pos, area: dict) -> pd.DataFrame`
    - `segment_by_gap(self, df_pos, gap_factor: float) -> list[pd.DataFrame]`
    - `plot(self, df_pos) -> matplotlib.figure.Figure`
    - `save_png(self, fig, path: str) -> str`

- stats_basic.py
  - 関数群
    - `compute_cc_stats(df_cc) -> dict`  # {"max":int,"mean":float,"median":float,"p95":float}
    - `save_stats_txt(stats: dict, path: str) -> str`

- naming.py / logging_util.py / validation.py はヒートマップ設計書の流儀に揃える。

## 3. 入力仕様
### 3-1) 中間形式テーブル（A工程出力）
形式：Pandas DataFrame

- df_cc（同時接続数系列）
  - 必須列: `second`(datetime UTC, 秒), `cc`(int, 人)
  - 制約: `second`昇順、`cc >= 0`、ユニーク`event_day`は1つ
- df_pos（位置系列）
  - 必須列: `second`(datetime UTC, 秒), `user_id`(string), `location_x`(float, m), `location_z`(float, m)
  - 任意列: `location_y`, `rotation_1/2/3`
  - 制約: `second`昇順、NaNは除外対象、ユニーク`event_day`は1つ
- area（描画境界）
  - 必須キー: `{x_min, x_max, z_min, z_max}`（float, m）
  - 制約: `x_max > x_min` かつ `z_max > z_min`

注記（時刻系）：列`second`はUTC（秒丸め済み）。タイトルやファイル名に含める`{event_day}`はJST基準。

### 3-2) B工程/WANT入力（任意）
- 属性テーブル: `user_id` をキーとする属性（色分けなどに使用、Want）

---

## 4. 出力仕様
- 画像サイズ: 1280×720（DPI=144、固定）
- ファイル命名: `{kind}-{event_day}-{filename}-{datetime}{ver}.{ext}`
  - `kind ∈ {cc_line, traj2D}`、`ext = png`
  - 統計テキスト: `stats-... .txt`
- 出力先: `/content/YAIBA_data/output/results/`（UI/UX設計に整合）
- グラフ仕様
  - 同時接続数グラフ
    - 軸: X=時間(JST, HH:MM)、Y=人数（人）
    - 線種: 実線、欠測>5×粒度で線分断
    - タイトル: `同時接続数の推移_{event_day}`
    - 凡例: なし（単系列）
  - 軌跡2D
    - 投影: x–z 平面
    - スケーリング: Area境界にfit（比率維持・中央寄せ）
    - 始点/終点: circle 6px / triangle 10px
    - 線幅: 1.5px、`break_gap_factor`による分断
    - タイトル: `ユーザー位置軌跡2D_{event_day}`
    - 軸ラベル: X=位置X[m], Z=位置Z[m]
- 統計TXT（UTF-8）
  - 形式:
    - `max: <int>`
    - `mean: <float>`
    - `median: <float>`
    - `p95: <float>`
