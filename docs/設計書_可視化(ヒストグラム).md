# C工程設計書
本文書は、YAIBAで生成されたログから統計・可視化・動画情報を取得する{名称未定}システムのC工程に関する設計書である。

C工程：A工程にて生成された中間形式テーブルに基づき、C-1の4項とC-2の4項に定める出力を得る工程であって、以下の2項目から成立する。
C-1. 滞在時間ヒストグラム生成工程
C-2. 動画生成工程

## C-1. 滞在時間ヒストグラム生成工程 設計書

### 1) 目的と範囲
#### 目的:
各ユーザ（またはグループ）の滞在時間の分布を可視化し、ピーク・ばらつき・外れ値を把握する。ユーザに対し、本システムにヒストグラム描画機能があることを知ってもらうことを目的とする。
#### 範囲:
中間形式テーブルを受け取り、E工程で設計されるUI上にヒストグラム(PNG形式)を出力するとともに、集計CSVを保存する。
#### 設計思想：
・ユーザに選択肢を与えない。出力ファイル名だけを入力してもらうWant要件が実装された場合、入力がない場合はデフォルト値を代入する

・在室秒数算出ルールは重複解決後のレコード数とする。入退室は判別せず、同一ユーザの出席秒数のみをカウントする

#### 今後の拡張想定(以下の内容をWant要件とする)：

・ユーザ属性テーブル(B工程出力想定)とuser_idをキーとして結合し、同テーブルの属性を凡例として加える。

・ユーザに凡例とビン幅のマニュアル入力を許可する(本仕様は自動計算)

・以上の拡張想定を考慮して、UI側からのデータの受け取りや他テーブルとのリレーションを実装する。

### 2) 成果物（ファイル名・ファイル構成）
#### 2-1)ファイル構成

```
/content/
├─ YAIBA_data/
│  ├─ input/                         # アップロードされたログ(text/CSV 等)
│  │   └─ <uploaded_log>.txt
│  └─ output/
│      ├─ results/                   # ユーザー配布物（フラット配置）
│      │   ├─ hist_dwell-{event_day}-{filename}-{datetime}_{ver}.png
│      │
│      └─ meta/                      # 開発・検証用（成果物には含めない）
│          ├─ configs/
│          │   └─ run_{ver}_params.yaml
│          └─ logs/
│              └─ run_{datetime}.log
│
├─ src/
│  └─ engine/
│      └─ core/
│          ├─ histogram.py           # C-1 実装（ヒストグラム）
│          ├─ validation.py          # 入力検証・必須列チェック・型/境界チェック
│          ├─ naming.py              # ファイル名/保存先パス生成（results直下に出力）
│          └─ logging_util.py        # 構造化ログ（INFO/WARN/ERROR）＋実行サマリ出力
│
└─ YAIBA_Visualizer_output.zip       # /YAIBA_data/output/results のみを同梱（フラット配置）

```

{event_day} : イベント開催日 (YYYY-MM-DD)、{datetime} : 実行日時 (YYYYMMDD_HHMMSS, JST)
{filename} : ユーザ定義の任意名称、{ver} : バージョン (例: c1.0, c2.0)、{duration} : 動画再生時間 [秒] (例: 120, 150, 180)

#### 2-2)コード実体

#### histogram.py
**クラス: `HistogramGenerator`**
- `__init__(self, boundary: dict, outlier: dict, theme: dict, io: dict)`  
  6項で定義したパラメータ
- `compute_dwell(self, df) -> pd.DataFrame`  
  在室秒数を算出  
  - 返り値カラム: `[user_id, dwell_seconds, dwell_minutes, event_day]`
- `plot(self, dwell_df) -> matplotlib.figure.Figure`  
  ヒストグラムを描画
- `save_csv(self, dwell_df, path: str) -> str`  
  CSV を保存（戻り値: 保存パス）
- `save_png(self, fig, path: str) -> str`  
  PNG を保存（戻り値: 保存パス）
- `run(self, df, output_basename: str) -> dict`  
  一括実行（命名・保存・ログを含む）  
  - 戻り値: `{"csv_path": str, "png_path": str, "log_path": str}`

#### core/validation.py
- `require_columns(df, cols: list[str]) -> None`  
  必須列が無ければ例外を投げる（不足列名を含める）
- `drop_invalid_types(df) -> tuple[pd.DataFrame, int]`  
  型不整合行を除去し、除外件数を返す
- `clip_by_boundary(df, boundary: dict) -> pd.DataFrame`  
  境界外データを除外
- `enforce_min_seconds(df, min_unique_seconds: int) -> None`  
  `unique(second) < 閾値` なら例外を発生（ユーザー向け文面は上位で変換）

#### core/naming.py
- `build_basename(event_day: str, filename: str, dt: str, ver: str, *, duration: int | None = None) -> str`  
  命名順: `event_day – filename – datetime – (movieのみ)duration – _ver`
- `result_path(kind: str, basename: str) -> str`  
  `kind ∈ {"image","table","movie"}` に応じて  
  `/YAIBA_data/output/results/images|tables|movies/...` を返す
- `meta_paths(dt: str, ver: str) -> dict`  
  `{"config_path": ..., "log_path": ...}` を返す

#### core/logging_util.py
- `get_logger(run_id: str)`  
  ファイル/コンソールの二重出力をセットアップ  
  - 保存先: `/meta/logs/run_{datetime}.log`
- `log_summary(logger, stats: dict)`  
  ユニーク件数、除外行数、保存先パスなどを整形出力


### 3) 入力仕様
#### 3-1)中間形式テーブル

※：中間形式という名で用語集にて定義済みなので省略可
形式：PandasDataFrame 

- **second** (必須, datetime UTC, 秒): 秒丸め済み時刻  
- **user_id** (必須, string): 参加者ID（仮名化済み）  
- **location_x / y / z** (必須, float, m): ワールド座標  
- **event_day** (必須, date JST, 日): イベント開催日 (YYYY-MM-DD)  
- **rotation_1/2/3** (任意, float, 度): 回転角度 pitch / yaw / roll

制約：
必須列の欠損行は除外。
ユニークなevent_dayは1つであること

注記（時刻系）：列`second`はUTC（秒丸め済み）、列`event_day`およびファイル名に含まれる`{event_day}`はJST基準。出力のタイトル等はJSTで表示する。

#### 3-2)B工程出力　ユーザ属性テーブル
※：本テーブルはwant要件。詳細はB工程設計と協議する
形式：PandasDataFrame  

- **user_id** (任意, string): 参加者の一意識別子（仮名化済み）  
- **isVR** (任意, bool): VRかどうか

### 4) 出力仕様

#### 4-1) 集計CSV：
ファイル名：dwell_summary_*.csv
形式：CSV(UTF-8)
- **user_id** (必須, string): 一意識別子  
- **dwell_seconds** (必須, int64, 秒): 在室時間の合計  
- **dwell_minutes** (推奨, float64, 分): 秒を60で割った表示用値  
- **event_day** (任意, string, YYYY-MM-DD): 層別・命名用

#### 4-2) ヒストグラム:
画像：PNG(960×720)
x軸：dwell_minutes，y軸：人数（件数），凡例：なし

### 5) 処理フロー（概要）
1,読込・正規化：中間形式テーブルを読み込み、型・タイムゾーン（UTC→JST表示用）整備。  

2,ソート・重複解決：`second`昇順→`user_id`でソート後、同一秒の重複は後勝ちとする。

3,外れ値除去：ログ開始から**duration_real**以上の時系列データと境界を超える座標を除外（境界は他工程で決定する）。

4,接続秒数取得：各`user_id`の出現秒数を在室秒数とする。集計CSV作成。

5,ヒスト用データ作成：ビン幅はFD法をベースにし、`bin_min_sec`〜`bin_max_sec`で制限。  

6,描画：Matplotlibでヒストグラムを描画。  

7,保存：集計テーブルと実行パラメータを出力、ログ記録。


### 6) パラメータ一覧

※ワールド境界の定義は上流工程が担うことが妥当とし、協議の上、A工程の設計を優先する。

※UIと関連が強いので、協議の上、E工程の設計を優先する。入力値は仮の値である。

#### 6-1) A工程
boundary:
- **location_x/y/z_min/max** (float, 任意): 各座標軸の下限・上限値
---
#### 6-2) E工程
theme:
- **palette** (string, default="tab10") — カラーマップ  
- **bg_color** (string, default="#eeeeee") — 背景色  
- **font** (string, default="Meiryo") — フォント  
- **font_size** (int, default=16) — フォントサイズ [pt]
---
#### 6-3) ユーザー
※本パラメータはWant要件
IO:
- **output_filename** (string, default="hist") — 出力ファイル名  
- **overwrite** (bool, default=false) — 既存ファイル上書き有無
---
#### 6-4) 内部
以下の項目はどの工程からも受け取らない。
- **duration_real** (int, default=10800) — 集計時間 [秒]　—  ログ開始から起算した動画対象のデータ時間。
- **bin_method** (string, default="FD") — ビン幅決定法  
- **bin_min_sec** (int, default=60) — ビン幅下限 [秒]  
- **bin_max_sec** (int, default=600) — ビン幅上限 [秒]    

### 7) 例外・エラー処理方針
本工程で発生し得る例外・エラーと、それに対する処理方針を以下に示す。  
ユーザー向けにはわかりやすい自然文を返却し、内部ではエラーコード体系（-21XX〜-24XX）に基づきログへ記録する。

---

#### 7-1. 必須列欠如
- **動作**: 実行停止。  
- **ユーザー向けメッセージ例**:  
  「アップロードされたデータに必要な列が見つかりません。`user_id`, `second` など必須項目を含めてください。」  
- **エラーコード**: `-2102: フォーマット不正`  

---

#### 7-2. 型不整合
- **動作**: 当該行を除外し、除外件数とサンプルをログ出力（処理は継続）。  
- **ユーザー向けメッセージ例**:  
  「一部の行で数値データに文字列など不正な値がありました。該当行は自動的に除外して処理を続行しました。」  
- **エラーコード**: `-2104: 型不一致`  

---

#### 7-3. 中間テーブルの許容範囲外値がある、中間テーブルが存在しない
- **動作**: 実行停止（ログに明示）。  
- **ユーザー向けメッセージ例**:  
  「｛文言はA工程の担当と相談の上で決める｝」  
- **エラーコード**: `-2105: 許容範囲外値` または `-2101: 入力ファイル欠落`（設定ファイルの場合）  

---

#### 7-4. データ不足
- **動作**: 有効ユーザー数が2未満の場合、処理は継続。ただし単峰ヒストグラムに「注記」または警告を付与。  
- **ユーザー向けメッセージ例**:  
  「利用可能なユーザーが1名以下のため、統計的な分布比較は行えません。参考として単一分布を表示します。」  
- **エラーコード**: `-2403: サンプル数不足`  

---

#### 7-5. 出力ディレクトリ不可
- **動作**: ディレクトリが存在しない場合は作成を試みる。作成失敗時は実行停止＋パスを明示。  
- **ユーザー向けメッセージ例**:  
  「出力先フォルダを作成できませんでした。書き込み権限またはディスク容量をご確認ください。」  
- **エラーコード**: `-2701: 出力CSV生成失敗`（movieの場合は動画ファイル出力も含む）  

---


### 8) 性能・品質要件
対象規模の目安：3時間×同時100ユーザ×1Hz ≈ 108万行

処理時間要件：　≤ 30秒　超過時は処理を継続し、警告ログ（処理時間・対象件数）を出力する。

再現性：すべてのパラメータをconfigs/run_*.yamlへ保存。

### 9) 検証方法（テスト条件）
#### ログ出力
5項に定める処理フローごとにログを残す。ログファイルの保存先は2項に示す通り。

1,読込・正規化：なし
2,ソート・重複解決：ユニークなuser_idの数, ユニークなsecondの数

3,ログ開始時刻の取得：ログ開始時刻　YYYYMMDD_HHMMSS（JST）

4,外れ値除去：event_day,時刻範囲

5,接続秒数取得：各user_idの最小秒数，最大秒数

6,ヒスト用データ作成：保存パスの出力

7,描画：描画が成功したかどうかの記録

8,画像保存：保存パスの出力

#### 視覚確認
出力されたヒストグラムのビン数が20程度(最低3本)