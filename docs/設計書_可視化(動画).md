# C工程設計書
本文書は、YAIBAで生成されたログから統計・可視化・動画情報を取得する{名称未定}システムのC工程に関する設計書である。

C工程：A工程にて生成された中間形式テーブルに基づき、C-1の4項とC-2の4項に定める出力を得る工程であって、以下の2項目から成立する。

C-1. 滞在時間ヒストグラム生成工程

C-2. 動画生成工程

## C-2. 動画生成設計書（x–z 平面アニメーション）

### 1) 目的と範囲
#### 目的:
空間内の動線・滞留・混雑の推移を、x–z 平面の時系列アニメで直感的に把握できるようにする。ユーザに対し、本システムに動画作成機能があることを知ってもらうことを目的とする。
#### 範囲:
中間形式テーブルを受け取り、E工程で設計されるUI上に60secの動画(mp4形式)を出力する。
#### 設計思想：
・ユーザに選択肢を与えない。出力ファイル名だけを入力してもらうWant要件が実装された場合、入力がない場合はデフォルト値を代入する

#### 今後の拡張想定(以下の内容をWant要件とする)：

・ユーザに描画人数、動画長さのマニュアル入力を許可する。

・在室人数推移テーブルと結合して、動画へ在室人数を表示する。

・ユーザが入力したフレーム単位でスナップショットをダウンロードできるサービスを実装する。

・以上の拡張想定を考慮して、UI側からのデータの受け取りや他テーブルとのリレーションを実装する。

### 2) 成果物（ファイル名・ファイル構成）
```
/content/
├─ YAIBA_data/
│  ├─ input/
│  │   └─ <uploaded_log>.txt
│  └─ output/
│     ├─ movie_xz-{event_day}-{filename}-{datetime}-{duration}s_{ver}.mp4
│     └─ （今後増える成果物もすべてここに直置き）
│     └─ meta/                            # 開発・検証用（Zipには含めない）
│          ├─ configs/
│          │   └─ run_{ver}_params.yaml
│          └─ logs/
│              └─ run_{datetime}.log
│
├─ src/
│  └─ engine/
│      └─ core/
│          ├─ movie.py                     # C-2 実装（動画生成）
│          ├─ validation.py
│          ├─ naming.py                    # results直下へのパス生成
│          └─ logging_util.py
│
└─ YAIBA_Visualizer_output.zip             # /YAIBA_data/output/results のみを同梱（フラット）

```

{event_day} : イベント開催日 (YYYY-MM-DD)、{datetime} : 実行日時 (YYYYMMDD_HHMMSS, JST)

{filename} : ユーザ定義の任意名称、{ver} : バージョン (例: c1.0, c2.0)、{duration} : 動画再生時間 [秒] (例: 120, 150, 180)


### 2-2) コード実体

#### movie.py
**クラス: `MovieGenerator`**

- `__init__(self, boundary: dict, outlier: dict, theme: dict, movie: dict, point: dict, trail: dict, io: dict)`    
- `prepare(self, df) -> pd.DataFrame`  
  整形・間引き・外れ値処理後の描画用データを返す。  
- `render(self, df) -> matplotlib.animation.FuncAnimation`  
  アニメーションを生成して返す（フレーム数 = `fps × duration_sec`）。  
- `save_mp4(self, anim, path: str) -> str`  
  MP4を保存（戻り値: 保存パス）。  
- `run(self, df, output_basename: str) -> dict`  
  一括実行（命名・保存・ログを含む）。  
  - 戻り値: `{"mp4_path": str, "log_path": str, "frames": int}`  

---

#### core/validation.py
- `require_columns(df, cols: list[str]) -> None`  
  必須列が無ければ例外を投げる（不足列名を含める）
- `drop_invalid_types(df) -> tuple[pd.DataFrame, int]`  
  型不整合行を除去し、除外件数を返す
- `clip_by_boundary(df, boundary: dict) -> pd.DataFrame`  
  境界外データを除外
- `enforce_min_seconds(df, min_unique_seconds: int) -> None` 

---

#### core/naming.py
- `build_basename(event_day: str, filename: str, dt: str, ver: str, *, duration: int | None = None) -> str`  
  命名順: `event_day – filename – datetime – (movieのみ)duration – _ver`
- `result_path(kind: str, basename: str) -> str`  
  `kind ∈ {"image","table","movie"}` に応じて  
  `/YAIBA_data/output/results/images|tables|movies/...` を返す
- `meta_paths(dt: str, ver: str) -> dict`  
  `{"config_path": ..., "log_path": ...}` を返す

---

#### core/logging_util.py
- `get_logger(run_id: str)`  
  ファイル/コンソールの二重出力をセットアップ  
  - 保存先: `/meta/logs/run_{datetime}.log`
- `log_summary(logger, stats: dict)`  
  ユニーク件数、除外行数、保存先パスなどを整形出力

---


### 3) 入力仕様
#### 3-1)中間形式テーブル
※：中間形式という名で用語集にて定義済みなので省略可
形式：PandasDataFrame 

- **second** (必須, datetime UTC, 秒): 秒丸め済み時刻  
- **user_id** (必須, string): 参加者ID（仮名化済み）  
- **location_x / y / z** (必須, float, m): ワールド座標  
- **event_day** (必須, date JST, 日): イベント開催日 (YYYY-MM-DD)  
- **rotation_1/2/3** (任意, float, 度): 回転角度 pitch / yaw / roll

制約：
必須列の欠損行は除外。
ユニークなevent_dayは1つであること

注記（時刻系）：列`second`はUTC（秒丸め済み）、列`event_day`およびファイル名に含まれる`{event_day}`はJST基準。出力のタイトル等はJSTで表示する。

#### 3-2)B工程出力　ユーザ属性テーブル
※：本テーブルはwant要件。詳細はB工程設計と協議する
形式：PandasDataFrame  

- **user_id** (任意, string): 参加者の一意識別子（仮名化済み）  
- **isVR** (任意, bool): VRかどうか

#### 3-3)B工程出力　在室人数推移テーブル
- **second** (必須, datetime UTC, 秒): 秒丸め済み時刻 (ISO 8601形式)  
- **attendees** (必須, int64, 人): 在室人数


### 4) 出力仕様
基本情報：
- **形式**: MP4 (H.264/AVC, yuv420p)  
- **解像度**: 960×720  
- **フレームレート**: 30fps  
- **ビットレート**: 2.0 Mbps  
- **再生**: 繰り返しなし

描画内容：
- **軸**: X=location_x, Y=location_z  
- **範囲**: 各軸の最小–最大
- **注釈**: 「YAIBA: ユーザー位置 2Dプロット」＋時刻表示
- **点群**: 各ユーザの現在位置（scatter）  
- **色**: ユーザごと or 固定（テーマ依存）  
- **トレイル**: 30秒相当（先頭α=1.0 → 末尾α=0.1）  
- **テロップ**: 現在時刻（JST）、（Want）在室人数

### 5) 処理フロー（概要）
1,読込・正規化：中間形式テーブルを読み込み、型・タイムゾーン（UTC→JST表示用）整備。  

2,ソート・重複解決：`second`昇順→`user_id`でソート後、同一秒の重複は後勝ちとする。

3,外れ値除去：ログ開始から**duration_real** 以上の時系列データと境界を超える座標を除外（境界は他工程で決定する）。 

4,secondサンプリング：ユニーク時刻から一般式に基づきサンプリング。計算式は下記の通り。

  圧縮率[-] = 元データ長[sec] / 再生時間[sec]  
  時間ステップ[sec] = 圧縮率[-] / fps[Hz]  

5,更新処理: 各フレームで位置座標と色を更新、タイトルに時刻を追記。  

6,アニメーション保存: matplotlib.animation (FuncAnimation + FFMpegWriter) により動画化し保存。

### 6) パラメータ一覧

※ワールド境界の定義は上流工程が担うことが妥当とし、協議の上、A工程の設計を優先する。

※UIと関連が強いので、協議の上、E工程の設計を優先する。入力値は仮の値である。

#### 6-1) A工程
boundary:
- **location_x/y/z_min/max** (float, 任意): 各座標軸の下限・上限値
---
#### 6-2) E工程
theme:
- **palette** (string, default="tab10") — カラーマップ  
- **bg_color** (string, default="#eeeeee") — 背景色  
- **font** (string, default="Meiryo") — フォント  
- **font_size** (int, default=16) — フォントサイズ [pt]
---
#### 6-3) ユーザー
※本パラメータはWant要件
IO:
- **output_filename** (string, default="hist") — 出力ファイル名  
- **overwrite** (bool, default=false) — 既存ファイル上書き有無

---
#### 6-4) 内部
以下の項目はどの工程からも受け取らない。
##### movie
- **duration_real** (int, default=10800) — 集計時間 [秒]　—  ログ開始から起算した動画対象のデータ時間。
- **format** (string, default="mp4") — 出力形式  
- **fps** (int, default=30) — フレームレート  
- **duration_sec** (int, default=60) — 再生時間 [秒]　—  不足は許容する。 
- **bitrate** (string, default="2M") — ビットレート  
##### point
- **radius_px** (int, default=6) — ユーザ位置半径 [px] 
- **alpha** (float, default=1.0) — 不透明度
##### trail
- **length_real_seconds** (int, default=30) — トレイル長 [秒]  
- **alpha_start** (float, default=1.0) — トレイル先頭透明度  
- **alpha_end** (float, default=0.1) — トレイル末尾透明度  

### 7) 例外・エラー処理方針
本工程で発生し得る例外・エラーと処理方針を以下に示す。  
ユーザー向けにはわかりやすい自然文を返却し、内部ではエラーコード体系（-21XX〜-24XX）に基づきログへ記録する。

---

#### 7-1. 必須列欠如
- **動作**: 実行停止。  
- **ユーザー向けメッセージ例**:  
  「アップロードされたデータに必要な列が見つかりません。`user_id`, `second` など必須項目を含めてください。」  
- **エラーコード**: `-2102: フォーマット不正`  

---

#### 7-2. 型不整合
- **動作**: 当該行を除外し、除外件数とサンプルをログ出力（処理は継続）。  
- **ユーザー向けメッセージ例**:  
  「一部の行で数値データに文字列など不正な値がありました。該当行は自動的に除外して処理を続行しました。」  
- **エラーコード**: `-2104: 型不一致`  

---

#### 7-3. 中間テーブルの許容範囲外値がある、中間テーブルが存在しない
- **動作**: 実行停止（ログに明示）。  
- **ユーザー向けメッセージ例**:  
  「｛文言はA工程の担当と相談の上で決める｝」  
- **エラーコード**: `-2105: 許容範囲外値` または `-2101: 入力ファイル欠落`（設定ファイルの場合）  

---

#### 7-4. データ不足（ユニーク second < 180）
- **動作**: 処理フロー3番にて、ユニークな `second` < 180 の場合は実行停止（ログ出力）。  
- **ユーザー向けメッセージ例**:  
  「入力ログが短すぎるため処理を実行できません。180秒以上のデータを使用してください。」  
- **エラーコード**: `-2403: サンプル数不足`  

---

#### 7-5. 出力ディレクトリ不可
- **動作**: ディレクトリが存在しない場合は作成を試みる。作成失敗時は実行停止＋パスを明示。  
- **ユーザー向けメッセージ例**:  
  「出力先フォルダを作成できませんでした。書き込み権限またはディスク容量をご確認ください。」  
- **エラーコード**: `-2701: 出力CSV生成失敗`（movieの場合は動画ファイル出力も含む）  

---
### 8) 性能・品質要件
対象規模目安：3時間×同時100ユーザ×1Hz ≈ 108万点

性能目標
前処理（読込・整形・外れ値除去） ≤ 30秒

フレーム生成（間引き＋描画） ≤ 90秒

エンコード（PNG連番→MP4変換） ≤ 60秒

総処理時間の目安 ≤ 3分

処理進捗を表示する（Want要件）

### 9) 検証方法（テスト条件）
#### 統合テスト
総フレーム数 = fps × duration_sec と MP4 実フレーム数が一致すること

動画の時刻バーが t0→t0+3h を正しく走る（圧縮率 が一致）

在室人数テロップ（attendees表示）が同時刻の集計値と一致
#### 視覚確認
トレイルの減衰（α=1.0→0.1）、長さ（30秒相当）が仕様通りに描画されていること

文字・点群が判読可能なこと
#### ログ出力
C-1の9項に定める内容のうち6番を除く内容をログへ残すことに加え、C-2の5項の4番が終了した時点でフレーム数をログに残す。