## 可視化（ヒートマップ）
本書はYAIBAで生成されたログから統計・可視化情報を取得する{名称未定}システムの全体的な可視化（ヒートマップ）に関する設計書である。

## 1.目的と範囲
### 目的
- 平面位置情報を加工しヒートマップを描画することで、ユーザーがイベント会場のどこに人が集まっているかを直感的に把握できるようにする。

### やること
- 期間と時間を指定してユーザーの位置情報をもとにヒートマップを描画する。
- ヒートマップは局所的に集中して解釈性がなくならないように正規化する。

### やらないこと
- C.可視化（滞在時間ヒストグラム・動画生成）で明らかになることの描画。
- データ分析特有の言葉の積極的な採用（ユーザーの目に入る箇所はできるだけ平易な言葉を使う）
- 動画生成は本仕様の対象外（C工程で作成される動画と役割が重複する部分があるため将来要件とした）

## 2. 成果物（ファイル名・ファイル構成）
### 2-1) ファイル構成
```
/content/
├─ YAIBA_data/
│  ├─ input/                         # アップロードされたログ(text/CSV 等)
│  │   └─ <uploaded_log>.txt
│  └─ output/
│      ├─ results/                   # ユーザー配布物（フラット配置）
│      │   └─ heatmap_2D-{event_day}-{filename}-{datetime}{ver}.png
│      │
│      └─ meta/                      # 開発・検証用（成果物には含めない）
│          ├─ configs/
│          │   └─ run_{ver}params.yaml
│          └─ logs/
│              └─ run_{datetime}.log
│
├─ src/
│  └─ engine/
│      └─ core/
│          ├─ heatmap.py             # ヒートマップ生成実装
│          ├─ validation.py          # 入力検証・必須列チェック・型/境界チェック
│          ├─ naming.py              # ファイル名/保存先パス生成（results直下に出力）
│          └─ logging_util.py        # 構造化ログ（INFO/WARN/ERROR）＋実行サマリ出力
```

### 2-2) コード実体（詳細仕様）

#### heatmap.py
**クラス: `HeatmapGenerator`**

**コンストラクタ:**
```python
def __init__(self, boundary: dict, resolution: dict, theme: dict, io: dict) -> None
```
- **引数**:
  - `boundary`: dict - 境界設定（x_min/max, z_min/max）
  - `resolution`: dict - 解像度設定（grid_resolution）
  - `theme`: dict - 表示テーマ設定（内部固定。外部からは受け取らない）
  - `io`: dict - 入出力設定（output_filename, overwrite）
- **戻り値**: None
- **説明**: 6項で定義したパラメータを受け取り初期化

**メソッド一覧:**

```python
def validate_input_data(self, df: pd.DataFrame) -> pd.DataFrame
```
- **引数**: `df` - 入力データフレーム
- **戻り値**: `pd.DataFrame` - 検証済みデータフレーム
- **説明**: 入力データの存在確認と整合性チェック、型変換を実施

```python
def convert_utc_to_jst(self, df: pd.DataFrame) -> pd.DataFrame
```
- **引数**: `df` - UTC時刻のデータフレーム
- **戻り値**: `pd.DataFrame` - JST時刻のデータフレーム
- **説明**: UTC時間をJST時間に変換

```python
def filter_by_period(self, df: pd.DataFrame, all_range: bool, start_day: str, end_day: str, start_time: str, end_time: str) -> pd.DataFrame
```
- **引数**:
  - `df` - 入力データフレーム
  - `all_range` - 全期間フラグ
  - `start_day` - 開始日付（YYYY-MM-DD形式）
  - `end_day` - 終了日付（YYYY-MM-DD形式）
  - `start_time` - 開始時刻（HH:MM形式）
  - `end_time` - 終了時刻（HH:MM形式）
- **戻り値**: `pd.DataFrame` - フィルタ済みデータフレーム
- **説明**: 期間フィルタリング処理。`all_range=True`時はスキップ。比較はJSTの`second`で実施し、境界は両端閉区間（start以上かつend以下）。`start > end`の論理矛盾は`-2302`で例外。

```python
def clip_outliers(self, df: pd.DataFrame, lower_percentile: int = 1, upper_percentile: int = 99) -> pd.DataFrame
```
- **引数**:
  - `df` - 入力データフレーム
  - `lower_percentile` - 下側クリップするパーセンタイル（デフォルト1）
  - `upper_percentile` - 上側クリップするパーセンタイル（デフォルト99）
- **戻り値**: `pd.DataFrame` - 外れ値クリップ済みデータフレーム
- **説明**: X/Z軸ともに指定パーセンタイルで両側クリップ。データ点が少ない場合や`p_low >= p_high`時は安全にスキップ。描画境界（bounds）には影響しない。

```python
def calculate_grid(self, df: pd.DataFrame, resolution: int, bounds: dict) -> np.ndarray
```
- **引数**:
  - `df` - 入力データフレーム
  - `resolution` - グリッド解像度
  - `bounds` - 描画範囲（A工程の`boundary`をそのまま渡す）
- **戻り値**: `np.ndarray` - 2次元グリッドデータ（カウント）
- **説明**: グリッド分割と集計処理。`numpy.histogram2d`等で高効率に集計し、返却配列の軸方向と描画時の`extent`/`origin`（例: `origin='lower'`）の対応を明確に定義する。

```python
def apply_gaussian_smoothing(self, grid_data: np.ndarray, sigma: float) -> np.ndarray
```
- **引数**:
  - `grid_data` - グリッドデータ
  - `sigma` - ガウシアンフィルタのシグマ値（ビン単位）。推奨は `sigma_bins = max(1, round(resolution * gaussian_sigma_ratio))`
- **戻り値**: `np.ndarray` - スムージング済みデータ
- **説明**: ガウシアンフィルタでスムージング

```python
def normalize_data(self, grid_data: np.ndarray, method: str = "minmax") -> np.ndarray
```
- **引数**:
  - `grid_data` - グリッドデータ
  - `method` - 正規化手法（"minmax"）
- **戻り値**: `np.ndarray` - 正規化済みデータ（0-1範囲）
- **説明**: データを0-1範囲に正規化

```python
def compute_metric(self, grid_counts: np.ndarray, metric: str = "density") -> np.ndarray
```
- **引数**:
  - `grid_counts` - グリッド集計カウント
  - `metric` - "density"（0-1正規化）| "count"（カウントそのまま）
- **戻り値**: `np.ndarray` - メトリクス変換後のデータ
- **説明**: メトリクスを計算。`density`はスムージング後に正規化するため本関数では正規化しない。`count`はカウント値のまま返す。

```python
def generate_heatmap(self, grid_data: np.ndarray, bounds: dict, theme: dict, metric: str) -> matplotlib.figure.Figure
```
- **引数**:
  - `grid_data` - メトリクス適用済みグリッドデータ
  - `bounds` - 描画範囲
  - `theme` - テーマ設定（内部固定）
  - `metric` - 凡例・カラー範囲の基準（"density"|"count"）
- **戻り値**: `matplotlib.figure.Figure` - ヒートマップ図
- **説明**: ヒートマップを描画。テーマ（背景色・グリッド線等）は内部固定とし、出力画像は必ず1280×720pxとなるようにDPIとfigsizeで保証する。カラーバー凡例は`metric`に応じて切替。

```python
def save_png(self, fig: matplotlib.figure.Figure, path: str) -> str
```
- **引数**:
  - `fig` - matplotlib図オブジェクト
  - `path` - 保存パス
- **戻り値**: `str` - 保存パス
- **説明**: PNG を保存。親ディレクトリが無ければ作成を試み、`overwrite=False`かつ既存時は`-2701`で停止。`bbox_inches='tight'`等で余白を調整し、保存後は図をクローズしてメモリを解放。

```python
def run(self, df: pd.DataFrame, output_basename: str, metric: str = "density", **params) -> dict
```
- **引数**:
  - `df` - 入力データフレーム
  - `output_basename` - 出力ベース名
  - `metric` - メトリクス（"density"|"count"）
  - `**params` - 追加パラメータ
- **戻り値**: `dict` - {"png_path": str, "log_path": str、}
- **説明**: 一括実行（命名・保存・ログを含む）。実行IDを生成しロガーを初期化。パラメータ自動補正（例: 解像度が5–100外→64）は`-2301`でログし継続。期間内データゼロやユニーク秒数不足は警告として扱い、空のヒートマップを生成し継続（`-2403`）.

#### core/validation.py
**関数一覧:**

```python
def require_columns(df: pd.DataFrame, cols: list[str]) -> None
```
- **引数**:
  - `df` - データフレーム
  - `cols` - 必須列名リスト
- **戻り値**: None
- **例外**: `ValueError` - 必須列が無い場合
- **説明**: 必須列が無ければ例外を投げる（不足列名を含め、エラーコード`-2102`を併記）。

```python
def drop_invalid_types(df: pd.DataFrame) -> tuple[pd.DataFrame, int]
```
- **引数**: `df` - データフレーム
- **戻り値**: `tuple[pd.DataFrame, int]` - (修正済みデータフレーム, 除外件数)
- **説明**: 型不整合行を除去し、除外件数を返す。代表例（最大5件）を`-2104`としてログ出力。

```python
def clip_by_boundary(df: pd.DataFrame, boundary: dict) -> pd.DataFrame
```
- **引数**:
  - `df` - データフレーム
  - `boundary` - 境界設定辞書
- **戻り値**: `pd.DataFrame` - 境界内データのみ
- **説明**: 境界外データを除外。包含条件は両端閉（min ≤ value ≤ max）。

```python
def enforce_min_seconds(df: pd.DataFrame, min_unique_seconds: int) -> None
```
- **引数**:
  - `df` - データフレーム
  - `min_unique_seconds` - 最小ユニーク秒数
- **戻り値**: None
- **例外**: `ValueError` - 条件を満たさない場合
- **説明**: `unique(second) < 閾値`なら例外（`-2403`、実測ユニーク秒数をメッセージに含む）。`run()`で捕捉し、警告扱いで空のヒートマップ生成に分岐可能とする。

#### core/naming.py
**関数一覧:**

```python
def build_basename(event_day: str, filename: str, dt: str, ver: str) -> str
```
- **引数**:
  - `event_day` - イベント日（JST）
  - `filename` - ファイル名
  - `dt` - 日時文字列
  - `ver` - バージョン
- **戻り値**: `str` - ベース名
- **説明**: 命名順: `event_day – filename – datetime – _ver`

```python
def result_path(kind: str, basename: str) -> str
```
- **引数**:
  - `kind` - ファイル種別（"image"）
  - `basename` - ベース名
- **戻り値**: `str` - 結果ファイルパス
- **説明**: `/YAIBA_data/output/results/` 直下に適切なパスを返す

```python
def meta_paths(dt: str, ver: str) -> dict
```
- **引数**:
  - `dt` - 日時文字列
  - `ver` - バージョン
- **戻り値**: `dict` - {"config_path": str, "log_path": str}
- **説明**: メタファイルパス辞書を返す

#### core/logging_util.py
**関数一覧:**

```python
def get_logger(run_id: str) -> logging.Logger
```
- **引数**: `run_id` - 実行ID
- **戻り値**: `logging.Logger` - ロガーオブジェクト
- **説明**: ファイル/コンソールの二重出力をセットアップ
- **保存先**: `/content/YAIBA_data/output/meta/logs/run_{datetime}.log`

```python
def log_summary(logger: logging.Logger, stats: dict) -> None
```
- **引数**:
  - `logger` - ロガーオブジェクト
  - `stats` - 統計情報辞書
- **戻り値**: None
- **説明**: ユニーク件数、除外行数、保存先パスなどを整形出力

### 2-3) 成果物一覧（ユーザー/開発）
- **ユーザー向け成果物**:
  - 画像: `heatmap_2D-{event_day}-{filename}-{datetime}{ver}.png`
- **開発成果物（Python）**:
  - ファイル: `src/engine/core/heatmap.py`（クラス: `HeatmapGenerator`）
  - 補助: `validation.py` / `naming.py` / `logging_util.py`
  - 主要メソッド・引数・戻り値は「2-2) コード実体」を参照

## 3. 入力仕様
中間形式テーブル：pd.DataFrame
| 物理名 | 必須かどうか | 型 | 単位 | 内容 | 備考 |
| ---- | ---- | ---- | ---- | ---- | ---- |
| second  | 必須 | datetime  | 秒 | 秒丸め済み時刻 | UTC |
| user_id  | 必須 | string | -- | 参加者ID（仮名化済み） |  |
| location_x | 必須 | float | m | ワールド座標 |  |
| location_z | 必須 | float | m | ワールド座標 |  |

## 4. 出力仕様
- 画像サイズ: 1280×720（既定、DPI=144）
- 形式: PNG（既定）、SVG（オプション）
- ファイル名: heatmap_2D_{start_day}-{end_day}_{start_time}-{end_time}.png
- 出力先：セル および `/content/YAIBA_data/output/results`（パスがUIUX設計書と異なる場合はUIUX設計書を優先する）
- グラフタイトル：イベントの混雑エリア_{day}_{start_time}-{end_time}
- 軸ラベル
  - X軸：X座標（タイトルのみで座標数値のラベルは出力しない）
  - Z軸：Z座標（タイトルのみで座標数値のラベルは出力しない）
- 軸目盛線：原点(0,0)が描画範囲に含まれる場合のみ、X軸・Z軸の中央線を描画
- 色：`viridis`（固定、色覚配慮）。カラーバーの vmin/vmax はスムージング後の配列に対する1–99%パーセンタイルで決定（表示スケーリングのみでデータ自体は変更しない）
- 凡例：グラフ右側に表示。`metric="density"` の場合は「密度(0-1)」、`metric="count"` の場合は「観測数(人・秒相当)」
- データラベル：なし

## 5. 処理フロー（概要）
- 入力データの検証・加工
  - 中間形式テーブル由来、ユーザー入力由来データの存在を確認
  - 中間形式テーブル由来、ユーザー入力由来データのデータ型を確認
  - secondをUTCからJSTへ変換
  - A工程のboundary外データを除外
- 期間フィルタリング
  - all_rangeがTrueの時は、期間フィルタリングを抜けて次の処理にいく
  - start_day/end_dayで日付を絞り込み
  - start_time/end_timeで時間帯を絞り込み
  - 日付・時間帯の境界は両端閉区間（start以上かつend以下）とする
  - フィルタ後のデータが空でないことを確認
- 外れ値クリップ
  - X軸・Z軸ともに 1–99% タイルで両側クリップ（描画範囲には影響しない）
- 描画範囲の決定
  - A工程のboundaryをそのまま描画範囲として採用（固定境界）
- グリッド分割の準備
  - X軸をresolution個のビンに等分割
  - Z軸をresolution個のビンに等分割
- グリッド集計
  - 各座標点がどのビンに属するかを判定
  - ビンごとにデータポイント数をカウント
  - resolution × resolutionの2次元配列として集計結果を格納
- メトリクス算出
  - `metric`に応じて配列を変換（density: 正規化は後段で実施、count: カウント値）
- データのスムージングと正規化
  - 2次元配列をガウシアンフィルタでスムージング処理（`sigma_bins = max(1, round(resolution*gaussian_sigma_ratio))` を目安、最小1）
  - `metric = "density"` の場合に0-1の範囲に正規化（`metric = "count"` の場合はスキップ）
- ヒートマップ描画
  - 2次元配列データをヒートマップとして出力仕様を満たすように描画
- ファイル出力
  - ヒートマップを出力仕様を満たすように出力
  - メモリの解放
  - 処理完了メッセージの表示

## 6. パラメータ一覧

### 6-1) A工程から受け取るパラメータ
**boundary（境界設定）:**
| パラメータ名 | 型 | 単位 | デフォルト値 | 説明 |
|------------|-----|------|------------|------|
| x_min | float | メートル | (必須) | X座標の最小値 |
| x_max | float | メートル | (必須) | X座標の最大値 |
| z_min | float | メートル | (必須) | Z座標の最小値 |
| z_max | float | メートル | (必須) | Z座標の最大値 |

※ A工程のAreaクラスから必須取得。未指定はエラー停止（固定境界方針）

---

### 6-2) ユーザー入力パラメータ
**io（入出力設定）:**
| パラメータ名 | 型 | 必須 | デフォルト値 | 説明 | UI形式 |
|------------|-----|------|------------|------|--------|
| output_filename | string | × | "heatmap" | 出力ファイル名 | テキスト入力 |
| overwrite | bool | × | False | 既存ファイル上書き | チェックボックス |

**period（期間設定）:**
| パラメータ名 | 型 | 必須 | デフォルト値 | 説明 | UI形式 |
|------------|-----|------|------------|------|--------|
| all_range | bool | ○ | False | 全期間を対象とする | チェックボックス「全期間」 |
| start_day | date | × | (データ最小日) | 開始日付（JST） | 日付選択/スライダー |
| end_day | date | × | (データ最大日) | 終了日付（JST） | 日付選択/スライダー |
| start_time | time | × | "00:00" | 開始時刻（HH:MM、JST） | 時刻選択/スライダー |
| end_time | time | × | "23:59" | 終了時刻（HH:MM、JST） | 時刻選択/スライダー |

**resolution（解像度設定）:**
| パラメータ名 | 型 | 必須 | デフォルト値 | 説明 | UI形式 |
|------------|-----|------|------------|------|--------|
| grid_resolution | int | ○ | 64 | 各軸のビン分割数（5-100） | 数値入力/スライダー |

**metric（メトリクス設定）:**
| パラメータ名 | 型 | 必須 | デフォルト値 | 値 | 説明 | UI形式 |
|------------|-----|------|------------|------|------|--------|
| metric | string | ○ | "density" | {"density","count"} | 凡例・色範囲の基準。density: 0-1 正規化、count: カウント値 | セレクト |

---

### 6-3) 内部パラメータ
以下のパラメータは他工程から受け取らず、内部で固定値として使用する。

**processing（処理設定）:**
| パラメータ名 | 型 | デフォルト値 | 説明 |
|------------|-----|------------|------|
| gaussian_sigma_ratio | float | 0.05 | ガウシアンフィルタのシグマ比率（解像度に対する相対値）。`sigma_bins = max(1, round(resolution * ratio))` |
| margin_ratio | float | 0.05 | 固定境界方針のため未使用（互換のため保持） |
| percentile_clip | tuple[int,int] | (1, 99) | 外れ値除外のパーセンタイル（下側, 上側） |
| min_unique_seconds | int | 10 | 最小ユニーク秒数（`enforce_min_seconds`で使用） |
| normalize_method | string | "minmax" | 正規化手法 |

**rendering（描画設定・内部固定）:**
| パラメータ名 | 型 | デフォルト値 | 説明 |
|------------|-----|------------|------|
| image_size_px | tuple | (1280, 720) | 出力画像サイズ [px]（固定） |
| dpi | int | 144 | 保存時の解像度 [dpi]（固定） |
| figsize | tuple | (8.8889, 5.0) | 画像サイズ [inch]。`image_size_px`と`dpi`から算出し、保存時に1280×720pxを厳密に満たすように使用 |

**logging（ログ設定）:**
| パラメータ名 | 型 | デフォルト値 | 説明 |
|------------|-----|------------|------|
| log_level | string | "INFO" | ログレベル |
| log_format | string | (構造化形式) | ログフォーマット |
| version | string | "v1.0" | 処理バージョン |
---

## 7. 例外・エラー処理方針
### 7-1. 必須列欠如
- **動作**: 実行停止。  
- **ユーザー向けメッセージ例**:  
 「アップロードされたデータに必要な列が見つかりません。`user_id`, `second`, `location_x`, `location_z` の必須項目を含めてください。」  
- **エラーコード**: `-2102: フォーマット不正`  
- **詳細**: 不足している列名をログに記録

---

### 7-2. 型不整合
- **動作**: 当該行を除外し、除外件数とサンプルをログ出力（処理は継続）。  
- **ユーザー向けメッセージ例**:  
 「一部の行で数値データに文字列など不正な値がありました。該当行は自動的に除外して処理を続行しました。（除外件数: XX件）」  
- **エラーコード**: `-2104: 型不一致`  
- **詳細**: 最初の5件のエラー内容をログに記録

---

### 7-3. 中間テーブルの不在または異常
- **動作**: 実行停止（ログに明示）。  
- **ユーザー向けメッセージ例**:  
 「中間形式テーブルが見つからないか、データ形式が正しくありません。A工程の処理が正常に完了しているか確認してください。」  
- **エラーコード**: `-2101: 入力ファイル欠落` または `-2105: 許容範囲外値`  
- **詳細**: ファイルパスと期待される形式を記録

---

### 7-4. データ不足
- **動作**: 警告を表示し、空のヒートマップを生成（処理は継続）。  
- **ユーザー向けメッセージ例**:  
 「指定された期間にデータが存在しないか、データ量が不足しています（ユニーク秒数: XX）。期間設定を確認してください。」  
- **エラーコード**: `-2403: サンプル数不足`  
- **詳細**: 実際のユニーク秒数と最小要求数（10秒）を記録

---

### 7-5. パラメータ異常
- **動作**: 自動補正または実行停止（パラメータによる）。  
- **ユーザー向けメッセージ例**:  
 - 期間矛盾: 「開始日時が終了日時より後になっています。期間設定を確認してください。」
 - 解像度範囲外: 「解像度は5〜100の範囲で指定してください。自動的に64に調整しました。」
 - boundary未指定: 「会場境界が未指定です。A工程の設定を確認してください。」
- **エラーコード**: 
 - `-2301: パラメータ範囲外` （自動補正可能）
 - `-2302: パラメータ論理エラー` （補正不可）
- **詳細**: 入力値と補正値（または期待値）を記録

---

### 7-6. 座標データ異常
- **動作**: 異常値を除外し警告表示（処理は継続）。  
- **ユーザー向けメッセージ例**:  
 「座標データに異常値（NaN、無限大）が含まれていました。該当データを除外して処理を続行しました。（除外件数: XX件）」  
- **エラーコード**: `-2106: 座標値異常`  
- **詳細**: 異常値の種類（NaN/Inf）と件数を記録

---

### 7-7. メモリ不足
- **動作**: 解像度を自動的に下げて再試行、失敗時は実行停止。  
- **ユーザー向けメッセージ例**:  
 「メモリ不足のため、解像度を自動的に調整しています。処理に時間がかかる場合があります。」  
- **エラーコード**: `-2501: メモリ不足`  
- **詳細**: 元の解像度と調整後の解像度を記録

---

### 7-8. 出力ディレクトリ不可
- **動作**: ディレクトリが存在しない場合は作成を試みる。作成失敗時は実行停止。  
- **ユーザー向けメッセージ例**:  
 「出力先フォルダを作成できませんでした。書き込み権限またはディスク容量をご確認ください。」  
- **エラーコード**: `-2701: 出力ファイル生成失敗`  
- **詳細**: 試行したパスとエラー詳細を記録

---

### エラーコード体系

| コード範囲 | カテゴリ | 説明 |
|-----------|---------|------|
| -21XX | 入力エラー | ファイル、データ形式の問題 |
| -22XX | データ品質 | データ内容の問題 |
| -23XX | パラメータ | 設定値の問題 |
| -24XX | 処理エラー | 計算・集計の問題 |
| -25XX | リソース | メモリ・CPU等の問題 |
| -26XX | 外部連携 | 他工程との連携問題 |
| -27XX | 出力エラー | ファイル保存の問題 |

### エラーログ形式
[YYYY-MM-DD HH:MM:SS] [ERROR] [Code: -XXXX] カテゴリ: エラー概要
Details: 詳細情報
Action: 実行したアクション（継続/停止/自動補正）
User Message: ユーザーに表示したメッセージ

## 8. 性能・品質要件

### 8-1) 性能要件
※処理時間要件およびメモリ使用量要件の目標値・許容値はLLMによる推計なので目安とする。

#### 対象データ規模
- **基準規模**: 毎秒 × 1時間 × 同時30ユーザー ≈ 108,000行
- **最大想定規模**: 毎秒 × 12時間 × 同時80ユーザー ≈ 3,456,000行
- **最小動作規模**: 毎秒 × 30分 × 1ユーザー ≈ 1,800行

#### 処理時間要件

| 処理フェーズ | 目標時間 | 許容時間 | 備考 |
|------------|---------|---------|------|
| データ読込・検証 | ≤ 5秒 | ≤ 10秒 | 108,000行基準 |
| 期間フィルタリング | ≤ 3秒 | ≤ 5秒 | インデックス使用時 |
| グリッド集計 | ≤ 10秒 | ≤ 15秒 | 64×64グリッド |
| 正規化・スムージング | ≤ 5秒 | ≤ 10秒 | ガウシアンフィルタ適用 |
| ヒートマップ描画 | ≤ 5秒 | ≤ 10秒 | 1280×720px |
| ファイル保存 | ≤ 2秒 | ≤ 5秒 | PNG |
| **総処理時間** | **≤ 30秒** | **≤ 55秒** | 全フェーズ合計 |

#### メモリ使用量要件

| データ規模 | 想定メモリ使用量 | 最大許容量 |
|-----------|---------------|-----------|
| 1,800行 | ≤ 10MB | 64MB |
| 108,000行 | ≤ 50MB | 256MB |
| 3,456,000行 | ≤ 1.6GB | 3GB |

※ Google Colab無料版（12GB RAM）での動作を保証

---

### 8-2) 品質要件

#### 再現性
- **要件**: 同一入力データ・パラメータで完全に同じ出力を保証
- **実装方法**:
 - 乱数シードの固定（必要な場合）
 - 処理順序の固定（ソート処理の明示）
 - 浮動小数点演算の丸め方法統一

#### 可用性
- **部分的データ欠損への対応**:
 - 必須列の欠損: エラー停止
 - 座標値のNaN: 該当行を除外して継続
 - 期間内データなし: 警告表示後、空のヒートマップ生成

#### 解釈性
- **色分布の適切性**:
 - データが1点のみ: 中間色で表示
 - 極端な偏り: 対数スケールオプション（Want要件）
 - 正規化により0-1範囲に収まることを保証
 - カラーバーのvmin/vmaxを1-99%クリップに設定し極端値で塗りつぶされないことを保証
- **視認性の確保**:
 - フォントサイズは解釈にあたって問題ないか

## 9.検証方法
### 単体テスト条件
ヒートマップ描画で以下の動作を確認する。
- 最小データセット: 1ユーザー、1時刻、1座標
- 標準データセット: イベント1開催分
- 大規模データセット: イベント複数開催分
- エッジケース
  - 全員が同一座標
  - 座標が1直線上に分布
  - 極端に偏った分布（会場の一角のみ）

### 統合テスト条件
以下の機能に問題ないか確認する。
- 期間フィルタリング
  - 全期間 → 特定日 → 特定時間帯の絞り込みが
  - 存在しない期間の指定
- 解像度変更: 5, 10, 20, 50, 64, 100での出力比較
- ファイル出力

### 受け入れテスト条件
以下の観点で問題ないか確認する。

#### 視覚的検証（定量基準）
- **色分布の一貫性**:
  - 1-99%クリップ採用時に高密度クラスタが1〜2つ以上視認可能
- **軸ラベル・タイトル表示**:
  - 軸ラベルが正しく表示されるか（X軸: X座標、Z軸: Z座標）
  - タイトルが指定形式で表示されるか
- **凡例の適切性**:
  - `metric="density"` の場合に「密度(0-1)」で表示されるか
  - `metric="count"` の場合に「観測数(人・秒相当)」で表示されるか
- **中央線の位置**:
  - 原点に線が引かれているか

#### 性能検証
- **処理時間**: 108,000行データで30秒以内（許容55秒）
- **メモリ使用量**: 108,000行データで50MB以内（最大256MB）

#### エラー処理検証
- **必須列欠如**: 適切なエラーメッセージとエラーコードが表示されるか
- **データ不足**: 警告表示後、空のヒートマップが生成されるか
